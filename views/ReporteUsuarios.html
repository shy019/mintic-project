<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
        rel="stylesheet" type="text/css" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v5.15.3/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
        rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/style.css">
    <title>Tienda Genérica</title>
</head>

<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="Principal.html">Inicio</a>
            <a class="navbar-brand" href="#" onclick="logOut()">Salir</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menú
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto py-4 py-lg-0">
                    <li id="linkUsuarios" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="Usuarios.html">Usuarios</a></li>
                    <li id="linkClientes" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="Clientes.html">Clientes</a></li>
                    <li id="linkProveedores" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="proveedores.html">Proveedores</a></li>
                    <li id="linkProductos" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="Productos.html">Productos</a></li>
                    <li id="linkVentas" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="Ventas.html">Ventas</a></li>
                    <li id="linkReportes" class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4"
                            href="Reportes.html">Reportes</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Page Header-->
    <header class="masthead" style="background-image: url('../assets/img/misiontic.jpg')">
        <div class="container position-relative px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="page-heading">
                        <h1>REPORTE USUARIOS</h1>
                        <span class="subheading" id="title-page">Reporte Usuarios</span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="mb-4">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="my-5">
                        <table id="table" class="table">
                            <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Cedula</th>
                                    <th scope="col">Nombre</th>
                                    <th scope="col">Correo Electrónico</th>
                                    <th scope="col">Usuario</th>
                                    <th scope="col">Password</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <!-- Footer-->
    <footer class="border-top">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <ul class="list-inline text-center">
                        <li class="list-inline-item">
                            <a href="https://twitter.com/DrFSharkness" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://www.facebook.com/cristian.p.gomez/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-facebook-f fa-stack-1x fa-inverse" target="_blank"></i>
                                </span>
                            </a>
                        </li>
                        <li class="list-inline-item">
                            <a href="https://github.com/shy019" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fas fa-circle fa-stack-2x"></i>
                                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>
                    <div class="small text-center text-muted fst-italic">Nunca pares de aprender. <br>Copyright &copy;
                        Cristian Pérez 2021</div>
                </div>
            </div>
        </div>
    </footer>
    <script>

        let table = document.getElementById("table");
        var userLoaded = localStorage.getItem("user");
        loadUsers();
        funcionarMenu(userLoaded);

        var titulo = document.getElementById("title-page");
        var tituloAnterior = titulo
        let pass;
        //Colocar Titulo
        titulo.innerText = "Conectado como: " + JSON.parse(userLoaded)?.username;
        rToken(JSON.parse(userLoaded));

        function funcionarMenu(userLoaded) {
            var linkUsuarios = document.getElementById("linkUsuarios");
            var linkClientes = document.getElementById("linkClientes");
            var linkProveedores = document.getElementById("linkProveedores");
            var linkVentas = document.getElementById("linkVentas");
            var linkReportes = document.getElementById("linkReportes");
            let role = 0;
            for (let index = 0; index < JSON.parse(userLoaded)?.roles.length; index++) {
                if (JSON.parse(userLoaded)?.roles[index] == "ROLE_USER") {
                    role += 1;
                } else if (JSON.parse(userLoaded)?.roles[index] == "ROLE_MODERATOR") {
                    role += 2;
                } else if (JSON.parse(userLoaded)?.roles[index] == "ROLE_ADMIN") {
                    role += 4;
                }
            }
            if (role == 3 || role == 2) {
                linkUsuarios.style = "display: none;";
                linkClientes.style = "display: block;";
                linkProveedores.style = "display: block;";
            } else if (role == 1) {
                linkUsuarios.style = "display: none;";
                linkClientes.style = "display: none;";
                linkProveedores.style = "display: none;";
            }
        }

        function loadTable(data, table) {
            let contador = 0;
            if (!document.getElementsByTagName) return;
            for (let element of data) {
                contador++;
                let obj = {
                    id: contador,
                    cedula: element.id,
                    nombre: element.name,
                    correo: element.email,
                    usuario: element.user,
                    password: element.password
                }
                let row = table.insertRow();
                for (key in obj) {
                    let text = "";
                    let cell = row.insertCell();
                    text = document.createTextNode(obj[key] == null ? "" : key == "password" ? coverPassword(obj[key].length) : obj[key]);
                    cell.appendChild(text);
                }
            }
        }

        function coverPassword(number) {
            let text = "";
            number = 6;
            while (number > 0) {
                text += "*";
                number--;
            }
            return text;
        }

        //Buscar usuarios
        async function loadUsers() {
            await rToken(JSON.parse(userLoaded)).then((token) => {
                fetch(`http://localhost:8090/mintic/tiendagenerica/api/user/all`,
                    {
                        type: 'GET',
                        mode: 'cors', // no-cors, *cors, same-origin
                        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                        credentials: 'same-origin', // include, *same-origin, omit
                        headers: {
                            'Content-Type': 'application/json',
                            'Access-Control-Allow-Origin': 'http://localhost:8090',
                            'Access-Control-Allow-Credentials': 'true',
                            'authorization': `Bearer ${token.accessToken}`
                            //'X-Custom-Header': `${JSON.parse(userLoaded)?.accessToken}`
                            //'Authorization': 
                            // 'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        redirect: 'follow', // manual, *follow, error
                        referrerPolicy: 'no-referrer',
                    })
                    .then(response => response.json())
                    .then(rsp => { loadTable(rsp, table) }).catch((e) => {
                        console.log(e)
                    }
                    )
            }).catch((e) => {
                console.log(e)
            });
        }

        function rToken(token) {
            return new Promise((resolve, reject) => {
                try {
                    obj = {
                        "refreshToken": token.refreshToken
                    }
                    fetch("http://localhost:8090/api/auth/refreshtoken",
                        {
                            method: 'POST',
                            mode: 'cors', // no-cors, *cors, same-origin
                            cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                            credentials: 'same-origin', // include, *same-origin, omit
                            headers: {
                                'Content-Type': 'application/json',
                                'Access-Control-Allow-Origin': 'http://localhost:8090',
                                'Access-Control-Allow-Credentials': 'true',
                                'authorization': `Bearer ${token.accessToken}`
                                //'X-Custom-Header': `${JSON.parse(userLoaded)?.accessToken}`
                                //'Authorization': 
                                // 'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            redirect: 'follow', // manual, *follow, error
                            referrerPolicy: 'no-referrer',
                            body: JSON.stringify(obj)
                        })
                        .then(function (response) {
                            return response.text();
                        }).then(function (text) {
                            if (JSON.parse(text).hasOwnProperty('accessToken')) {
                                resolve(JSON.parse(text));
                            } else {
                                reject(window.location.href = "C:/Users/david/OneDrive/Imágenes/mintic/views/Inicio.html");
                            }
                        }).catch((e) => {
                            reject(window.location.href = "C:/Users/david/OneDrive/Imágenes/mintic/views/Inicio.html");
                        }
                        );
                } catch {
                    reject(window.location.href = "C:/Users/david/OneDrive/Imágenes/mintic/views/Inicio.html");
                }
            });
        }

        function logOut() {
            sessionStorage.removeItem("user");
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = "C:/Users/david/OneDrive/Imágenes/mintic/views/Inicio.html";
        }
    </script>
</body>

</html>